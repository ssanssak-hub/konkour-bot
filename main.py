import logging
import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command, CommandStart
from aiogram.webhook.aiohttp_server import SimpleRequestHandler, setup_application
from aiohttp import web
import random
from datetime import datetime
import os

from config import BOT_TOKEN, MOTIVATIONAL_MESSAGES, ADMIN_ID
from exam_data import EXAMS_1405
from keyboards import (
    main_menu, exams_menu, exam_actions_menu, 
    study_plan_menu, stats_menu, admin_menu,
    back_button_menu
)

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø¨Ø§Øª Ùˆ Ø¯ÛŒØ³Ù¾Ú†Ø±
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ¨â€ŒÙ‡ÙˆÚ©
WEBHOOK_PATH = "/webhook"
WEBHOOK_URL = os.environ.get("WEBHOOK_URL", "https://konkour-bot-4i5p.onrender.com") + WEBHOOK_PATH

# --- Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ---

@dp.message(CommandStart())
async def start_handler(message: types.Message):
    user = message.from_user
    logger.info(f"ğŸ¯ Ø¯Ø±ÛŒØ§ÙØª /start Ø§Ø² {user.first_name} ({user.id})")
    
    welcome = f"""
ğŸ‘‹ Ø³Ù„Ø§Ù… {user.first_name} Ø¹Ø²ÛŒØ²!
Ø¨Ù‡ Ø±Ø¨Ø§Øª Ú©Ù†Ú©ÙˆØ± Û±Û´Û°Ûµ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ! ğŸ¯

ğŸ“š <b>Ø§Ù…Ú©Ø§Ù†Ø§Øª Ø±Ø¨Ø§Øª:</b>
â€¢ â³ Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ Ú©Ù†Ú©ÙˆØ±Ù‡Ø§
â€¢ ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡  
â€¢ ğŸ“Š Ø¢Ù…Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ
â€¢ ğŸ’« Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ

Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± ÛŒÚ©ÛŒ Ø§Ø² Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†:
"""
    await message.answer(welcome, reply_markup=main_menu(), parse_mode="HTML")

@dp.message(Command("test"))
async def test_handler(message: types.Message):
    logger.info(f"ğŸ§ª Ø¯Ø±ÛŒØ§ÙØª /test Ø§Ø² {message.from_user.id}")
    await message.answer("âœ… Ø±Ø¨Ø§Øª Ø¨Ø§ aiogram + webhook Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯! ØªØ³Øª Ù…ÙˆÙÙ‚.")

# --- Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ ---

@dp.message(F.text == "â³ Ø²Ù…Ø§Ù†â€ŒØ³Ù†Ø¬ÛŒ Ú©Ù†Ú©ÙˆØ±Ù‡Ø§")
async def exams_menu_handler(message: types.Message):
    logger.info(f"â° Ú©Ø§Ø±Ø¨Ø± {message.from_user.id} Ù…Ù†ÙˆÛŒ Ú©Ù†Ú©ÙˆØ±Ù‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯")
    await message.answer("ğŸ¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ú©ÙˆØ± Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±:", reply_markup=exams_menu())

@dp.message(F.text == "ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡")
async def study_plan_handler(message: types.Message):
    logger.info(f"ğŸ“… Ú©Ø§Ø±Ø¨Ø± {message.from_user.id} Ù…Ù†ÙˆÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯")
    await message.answer(
        "ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡:\n\n"
        "ğŸ¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯...",
        reply_markup=study_plan_menu()
    )

@dp.message(F.text == "ğŸ“Š Ø¢Ù…Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ")
async def stats_handler(message: types.Message):
    logger.info(f"ğŸ“Š Ú©Ø§Ø±Ø¨Ø± {message.from_user.id} Ù…Ù†ÙˆÛŒ Ø¢Ù…Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯")
    await message.answer(
        "ğŸ“Š Ø¢Ù…Ø§Ø± Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ:\n\n"
        "ğŸ“ˆ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯...",
        reply_markup=stats_menu()
    )

@dp.message(F.text == "ğŸ‘‘ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª")
async def admin_handler(message: types.Message):
    user = message.from_user
    logger.info(f"ğŸ‘‘ Ú©Ø§Ø±Ø¨Ø± {user.first_name} Ù…Ù†ÙˆÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯")
    
    if user.id != ADMIN_ID:
        await message.answer("âŒ Ø¯Ø³ØªØ±Ø³ÛŒ denied!")
        return
        
    await message.answer(
        "ğŸ‘‘ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª:\n\n"
        "ğŸ› ï¸ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯...",
        reply_markup=admin_menu()
    )

# --- Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§ÛŒ Ú©Ø§Ù„â€ŒØ¨Ú© ---

@dp.callback_query(F.data.startswith("exam_"))
async def exam_callback_handler(callback: types.CallbackQuery):
    exam_key = callback.data.replace("exam_", "")
    logger.info(f"ğŸ”˜ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ú©Ù†Ú©ÙˆØ±: {exam_key}")
    
    if exam_key not in EXAMS_1405:
        await callback.answer("âŒ Ø¢Ø²Ù…ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯")
        return
    
    exam = EXAMS_1405[exam_key]
    now = datetime.now()
    
    dates = exam["date"] if isinstance(exam["date"], list) else [exam["date"]]
    future_dates = [datetime(*d) for d in dates if datetime(*d) > now]
    
    if not future_dates:
        countdown = "âœ… Ø¨Ø±Ú¯Ø²Ø§Ø± Ø´Ø¯Ù‡"
    else:
        target = min(future_dates)
        delta = target - now
        days = delta.days
        hours = delta.seconds // 3600
        minutes = (delta.seconds % 3600) // 60
        countdown = f"â³ {days} Ø±ÙˆØ² Ùˆ {hours} Ø³Ø§Ø¹Øª Ùˆ {minutes} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡"
    
    message = f"""
ğŸ“˜ <b>{exam['name']}</b>
ğŸ“… ØªØ§Ø±ÛŒØ®: {exam['persian_date']}
ğŸ•’ Ø³Ø§Ø¹Øª: {exam['time']}

{countdown}

ğŸ¯ {random.choice(MOTIVATIONAL_MESSAGES)}
"""
    await callback.message.edit_text(
        message, 
        reply_markup=exam_actions_menu(exam_key), 
        parse_mode="HTML"
    )

@dp.callback_query(F.data == "show_all_exams")
async def all_exams_handler(callback: types.CallbackQuery):
    logger.info(f"ğŸ“‹ Ú©Ø§Ø±Ø¨Ø± {callback.from_user.id} Ù‡Ù…Ù‡ Ú©Ù†Ú©ÙˆØ±Ù‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯")
    
    message = "â³ <b>Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ú©Ù†Ú©ÙˆØ±Ù‡Ø§ÛŒ Û±Û´Û°Ûµ</b>\n\n"
    
    for exam_key, exam in EXAMS_1405.items():
        now = datetime.now()
        dates = exam["date"] if isinstance(exam["date"], list) else [exam["date"]]
        future_dates = [datetime(*d) for d in dates if datetime(*d) > now]
        
        message += f"ğŸ¯ <b>{exam['name']}</b>\n"
        message += f"ğŸ“… {exam['persian_date']} - ğŸ•’ {exam['time']}\n"
        
        if future_dates:
            target = min(future_dates)
            delta = target - now
            message += f"â³ {delta.days} Ø±ÙˆØ² Ùˆ {delta.seconds // 3600} Ø³Ø§Ø¹Øª Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡\n"
        else:
            message += "âœ… Ø¨Ø±Ú¯Ø²Ø§Ø± Ø´Ø¯Ù‡\n"
        
        message += "â”€" * 30 + "\n\n"
    
    message += f"ğŸ’« <i>{random.choice(MOTIVATIONAL_MESSAGES)}</i>"
    
    await callback.message.edit_text(
        message, 
        reply_markup=exam_actions_menu(), 
        parse_mode="HTML"
    )

@dp.callback_query(F.data == "back_to_main")
async def back_to_main_handler(callback: types.CallbackQuery):
    logger.info(f"ğŸ  Ú©Ø§Ø±Ø¨Ø± {callback.from_user.id} Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª")
    await callback.message.edit_text(
        "ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ:",
        reply_markup=main_menu()
    )

# --- Ù‡Ù†Ø¯Ù„Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ ---
@dp.message()
async def unknown_handler(message: types.Message):
    logger.info(f"ğŸ“ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø§Ø² {message.from_user.id}: {message.text}")
    await message.answer(
        "ğŸ¤” Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…!\n\nÙ„Ø·ÙØ§Ù‹ Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:",
        reply_markup=main_menu()
    )

# --- ØªÙˆØ§Ø¨Ø¹ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ÙˆØ¨â€ŒÙ‡ÙˆÚ© ---
async def on_startup(bot: Bot):
    """ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ù‡Ù†Ú¯Ø§Ù… Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ"""
    webhook_url = os.environ.get("WEBHOOK_URL", "https://konkour-bot-4i5p.onrender.com") + "/webhook"
    await bot.set_webhook(webhook_url)
    logger.info(f"âœ… ÙˆØ¨â€ŒÙ‡ÙˆÚ© ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯: {webhook_url}")

async def on_shutdown(bot: Bot):
    """Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ù‡Ù†Ú¯Ø§Ù… Ø®Ø§Ù…ÙˆØ´ÛŒ"""
    await bot.delete_webhook()
    logger.info("âŒ ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø­Ø°Ù Ø´Ø¯")

def main():
    """ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ"""
    app = web.Application()
    
    # Ø«Ø¨Øª Ù‡Ù†Ø¯Ù„Ø± ÙˆØ¨â€ŒÙ‡ÙˆÚ©
    SimpleRequestHandler(
        dispatcher=dp,
        bot=bot,
    ).register(app, path="/webhook")
    
    # ØªÙ†Ø¸ÛŒÙ… startup/shutdown
    app.on_startup.append(on_startup)
    app.on_shutdown.append(on_shutdown)
    
    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆØ±
    port = int(os.environ.get("PORT", 10000))
    logger.info(f"ğŸš€ Ø³Ø±ÙˆØ± Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª {port}...")
    
    web.run_app(app, host="0.0.0.0", port=port)

if __name__ == "__main__":
    main()
